# Section10: 모니터링 메트릭 활용

CPU 사용량, 메모리 사용량, 톰캣 쓰레드, DB 커넥션 풀과 같은 공통으로 사용되는 기술 메트릭은 이미 등록되어 있고, 이 메트릭을 사용해 대시보드를 구성해 모니터링 하면 된다.

여기에 더해 비즈니스에 특화된 모니터링 또한 구현에 따라 메트릭을 직접 등록해 확인할 수 있다.
ex) 주문 수, 취소 수, 재고 수

## MeterRegistry

마이크로미터 기능을 제공하는 핵심 컴포넌트로 스프링을 통해 주입받아 사용

## Counter(카운터)

- 단조롭게 증가하는 단일 누적 측정항목
    - 단일 값
    - 보통 하나씩 증가
    - 누적이므로 전체 값을 포함(total)
    - 프로메테우스에서는 일반적으로 카운터의 이름 마지막에 _total 을 붙여서 my_order_total 과같이 표현함
- 값을 증가하거나 0으로 초기화 하는 것만 가능
- 마이크로미터에서 값을 감소하는 기능도 지원하지만, 목적에 맞지 않음
- 예) HTTP 요청수

## 메트릭 등록 - @Counted

`@Counted` 어노테이션을 측정 대상 메서드에 적용하여 메트릭 등록을 할 수 있다.

- `CountedAspect` 를 등록해야 `@Counted` 를 인지해서 `Counter` 를 사용하는 AOP를 적용할 수 있다.

## 메트릭 - Timer

시간을 측정하는 메트릭 측정 도구

- Timer 는 다음과 같은 내용을 한번에 측정해준다.
    - seconds_count : 누적 실행 수
    - seconds_sum : 실행 시간의 합
    - seconds_max : 최대 실행 시간(가장 오래걸린 실행 시간)
        - 내부에 타임 윈도우라는 개념이 있어서 1~3분 마다 최대 실행 시간이 다시 계산된다.

## 메트릭 등록 - @Timed

타이머는 `@Timed` 어노테이션을 통해 AOP를 적용할 수 있다.

- `TimedAspect` 를 적용해야 `@Timed` 에 AOP가 적용된다.

## 메트릭 등록 - 게이지

- 게이지는 임의로 오르내릴 수 있는 단일 숫자 값을 나타내는 메트릭
- 값의 현재 상태를 보는데 사용
- 값이 증가하거나 감소할 수 있음
- 예) 차량의 속도, CPU 사용량, 메모리 사용량

**+ 카운터와 게이지를 구분할 때, 값이 감소할 수 있는가를 고민해보면 좋다.**

## 실무 모니터링 환경 구성 팁

### **모니터링 3단계**

- 대시보드
- 애플리케이션 추적 - 핀포인트
- 로그

### 대시보드

- 제품을 한눈에 볼 수 있는 가장 높은 뷰
- 모니터링 대상
    - 시스템 메트릭(CPU, 메모리)
    - 애플리케이션 메트릭(톰캣 쓰레드 풀, DB 커넥션 풀, 애플리케이션 호출 수)
    - 비즈니스 메트릭(주문 수, 취소 수)

### 애프리케이션 추적

주로 각각의 HTTP 요청을 추적, 일부는 마이크로서비스 환경에서 분산 추적

제품: 핀포인트(오픈소스), 스카우트(오픈소스), 와탭(상용), 제니퍼(상용)

### 로그

가장 자세한 추적, 원하는데로 커스텀 가능

같은 HTTP 요청을 묶어서 확인할 수 있는 방법이 중요, MDC 적용

**파일로 직접 로그를 남기는 경우**

- 일반 로그와 에러 로그는 파일을 구분
- 에러 로그만 확인해서 문제를 바로 정리할 수 있음

**클라우드에 로그를 저장하는 경우**

- 검색이 잘 되도록 구분
