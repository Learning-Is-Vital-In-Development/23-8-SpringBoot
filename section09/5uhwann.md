# Section9: 마이크로미터, 프로메테우스, 그라파나

## 마이크로미터

모니터링 툴의 작동을 위해 시스템의 다양한 지표들을 모니터링 툴에 맞게 가공해 전달해야 한다.

따라서 도중에 모니터링 툴을 변경 시, 기존 모니터링 툴에 맞게 측정한 코드를 변경한 모니터링 툴에 맞는 측정 코드로 변경해야 하는 문제가 발생한다.

→ 마이크로미터를 통해 해결

### 마이크로미터 추상화

- 마이크로미터는 애플리케이션 메트릭(측정 지표)을 표준 방법으로 모아 제공
- 스프링 부트 액츄에이터는 마이크로미터를 기본으로 내장해서 사용
- 개발자는 마이크로미터가 정한 표준 방법으로 메트릭(측정 지표)를 전달하면 된다. 그리고 사용하는 모니터링 툴에 맞는 구현체를 선택하면 된다.

### 메트릭 확인하기

스프링 부트 액츄에이터는 마이크로미터가 제공하는 지표 수집을 `@AutoConfiguration`을 통해 자동으로 등록해주기 때문에 수 많은 메트릭을 편리하게 사용할 수 있다.

### 다양한 메트릭

마이크로미터와 액츄에이터가 기본으로 제공하는 다양한 메트릭

- JVM 메트릭
- 시스템 메트릭
- 애플리케이션 시작 메트릭
- 스프링 MVC 메트릭
- 톰캣 메트릭
- 데이터 소스 메트릭
- 로그 메트릭
- 기타, 사용자 정의 메트릭

**스프링 MVC 메트릭**

스프링 MVC 컨트롤러가 처리하는 모든 요청을 다룬다.

**데이터소스 메트릭**

`DataSource`, 커넥션 풀에 관한 메트릭을 확인할 수 있다.

`jdbc.connections.` 으로 시작한다.

최대 커넥션, 최소 커넥션, 활성 커넥션, 대기 커넥션 수 등을 확인할 수 있다.

히카리 커넥션 풀을 사용하면 `hikaricp.` 를 통해 히카리 커넥션 풀의 자세한 메트릭을 확인할 수 있다.

**톰캣 메트릭**

톰캣 메트릭을 모두 사용하려면 설정 파일을 통해 설정 옵션을 설정해야 함.

## 프로메테우스와 그라파나

**프로메테우스**

수집한 메트릭을 보관하는 DB역할을 담당

**그라파나**

보관된 메트릭을 사용자가 보기 편하게 다양한 툴을 사용해 디스플레이 해주는 역할

**전체 구조**

1.  스프링 부트 액츄에이터와 마이크로미터를 사용하면 수 많은 메트릭을 자동으로 생성한다.
    1. 마이크로미터 프로메테우스 구현체는 프로메테우스가 읽을 수 있는 포멧으로 메트릭을 생성한다.
2. 프로메테우스는 이렇게 만들어진 메트릭을 지속해서 수집한다.
3. 프로메테우스는 수집한 메트릭을 내부 DB에 저장한다.
4. 사용자는 그라파나 대시보드 툴을 통해 그래프로 편리하게 메트릭을 조회한다. 이때 필요한 데이터는프로메테우스를 통해서 조회한다.

### 프로메테우스 - 애플리케이션 설정

프로메테우스가 애플리케이션의 메트릭을 수집하도록 연동하기 위한 작업

1. 애플리케이션 설정: 프로메테우스가 메트릭을 가져갈 수 있도록 애플리케이션에서 프로메테우스 포맷에 맞춰 메트릭 생성
2. 프로메테우스 설정: 프로메테우스가 애플리케이션의 메트릭을 주기적으로 수집하도록 설정

**애플리케이션  설정**

build.gradle 추가

```groovy
implementation 'io.micrometer:micrometer-registry-prometheus' //추가
```

- 스프링 부트와 액츄에이터가 자동으로 마이크로미터 프로메테우스 구현체를 등록해서
  동작하도록 설정해준다.
- 액츄에이터에 프로메테우스 메트릭 수집 엔트포인트 자동 추가

### 프로메테우스 - 수집 설정

프로메테우스 폴더에 있는 `prometheus.yml` 파일을 수정.

```groovy
#추가
- job_name: "spring-actuator"
      metrics_path: '/actuator/prometheus'
      scrape_interval: 1s #운영 단계에서 수집 주기는 (10s ~ 1m)
      static_configs:
        - targets: ['localhost:8080']
```

### 프로메테우스 - 게이지와 카운터

메트릭은 크게 보면 게이지와 카운터로 분리 가능

**게이지(Gauge)**

- 임의로 오르내일 수 있는 값. 예) CPU 사용량, 메모리 사용량, 사용중인 커넥션

**카운터(Counter)**

- 단순하게 증가하는 단일 누적 값. 예) HTTP 요청 수, 로그 발생 수
- 카운터는 계속해서 누적 증가하는 값이기 때문에 `increase()`, `rate()` 함수를 통해 증가율을 확인할 수 있다.
    - `increase()`: 지정 시간 단위별 증가값을 확인

      `increase(http_server_requests_seconds_count{uri="/log"}[1m])`

    - `rate`: 초당 증가율 확인

### 그라파나 - 연동

그라파나는 프로메테우스를 통해 조회한 데이터를 보여주는 역할을 한다.

프로메테우스를 데이터 소스로 사용해 데이터를 읽어와야 한다.

### 그라파나 - 메트릭을 통한 문제 확인

실무에서 주로 발생하는 대표적인 문제

- CPU 사용량 초과
- JVM 메모리 사용량 초과
- 커넥션 풀 고갈
- 에러 로그 급증

메트릭을 보는 것은 정확한 값을 보는 것이 목적이 아니라, 대략적인 값과 추세를 확인하는 것이 주 목적이다.
