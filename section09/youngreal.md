# 마이크로미터 


### 마이크로미터 소개

![](https://velog.velcdn.com/images/rodlsdyd/post/66dc5398-8245-480b-be26-50ea776fe602/image.png)

모니터링 툴에 CPU,JVM,커넥션정보 등을 전달한다고할때 모니터링 툴이 정한 포맷에 맞춰 측정,전달해야한다.

만약 모니터링툴이 변경된다면 변경된 모니터링 툴의 포맷에 맞춰 측정,전달하는 부분의 코드를 변경해야하는 문제가 발생한다. 

이를 **마이크로미터** 라는 라이브러리가 해결해준다. 
- 모니터링 구현체를 쉽게 갈아끼울수 있도록 추상화된 라이브러리 
- 스프링부트 액츄에이터가 기본으로 내장해서 사용한다.


### 메트릭 확인하기

스프링 부트 액츄에이터를 통해  수많은 메트릭을 확인할수있다.
JVM,MVC,톰캣,로그 등등..뿐 아니라 메트릭을 커스텀하게 정의할수있다. (주문수, 취소수 등의 메트릭..)

액츄에이터에서 메트릭을 확인할수있지만 메트릭들을 지속적으로 수집,보관할 DB가 필요하고 그래프를 통해 한눈에 쉽게 확인할수있는 대시보드도 필요하다. **(몇시간전 데이터를 확인하고싶다면? 서버내리기 전의 데이터를 확인하고싶다면?)**

### 프로메테우스와 그라파나

![](https://velog.velcdn.com/images/rodlsdyd/post/a6f75541-d756-4ed8-99be-148a23a10b14/image.png)


프로메테우스
- 과거 이력까지 함께확인하기위해 메트릭을 보관하는 DB가 필요한데 프로메테우스가 이런역할을 한다

그라파나
- 사용자가 보기편하게보여주는 대시보드


프로메테우스가 지속적으로 메트릭들을 수집하여 내부 DB에 저장하고
그라파나 대시보드 툴을 통해 매트릭을 조회한다. 


### 프로메테우스 애플리케이션 설정

애플리케이션에서 프로메테우스 포맷에 맞춰 메트릭 만들는 **애플리케이션 설정**, 프롬테우스가 애플리케이션의 메트릭을 주기적으로 수집하도록 하는 **프로메테우스 설정**이 필요하다

build.gralde에 프로메테우스 라이브러리만 등록만 해줘도
부트 액츄에이터가 자동으로 프로메테우스 구현체를 등록해 동작하도록 설정해준다.

### 프로메테우스 수집 설정

prometheus.yml에 수집경로, IP, PORT, 수집주기등을 설정한다. 

### 프로메테우스 기본기능


- 과거 시간 선택후 조회한다던지 , 메트릭을 그래프로 조회 가능하다

- 레이블 조건 필터를 이용해 필터링 할수도있다. 
  - http_server_requests_seconds_count{uri="/log", method="GET"}
  - http_server_requests_seconds_count{method=~"GET|POST"}
  
- 연산자 지원

### 프로메테우스 - 게이지와 카운터

게이지
- 오르락 내리락 하는 값 
- 그대로 출력하면 된다

카운터
- 단순하게 증가하는 누적 값
- 무조건 우상향그래프, 인사이트를 얻기 힘들다. 

> HTTP request 메트릭을 그래프로 표현하게되면 누적증가값만 확인할수있게 되는데
특정 시간에 고객 요청을 확인하는경우에는 increase(), rate() 같은 함수도 지원한다.

increase()

- 지정한 시간 단위별로 증가를 확인할수있다.

rate()

- 초당 평균 증가율을 계산한다
  - 초당 얼마나 증가하는지 나타내는 지표
  
irate()

- 초당 순간 증가율 확인(증가율)
- 급격하게 증가한 내용을 확인하기 좋음 


### 그라파나

프로메테우스 만으로는 보기편하게 데이터를 조회할수없다.
이때 프로메테우스에 있는 데이터를 불러서 **사용자가 보기편하게 해주는** 대시보드가 그라파나다.

- 대시보드는 직접 만들수있으며 이미 만들어진 공유 대시보드를 활용할수도있다.

- 아래 내용들을 확인해 장애 상황에 빠르게 대응하는걸 도와줄수있다.
  - CPU 사용량 초과
  - JVM 메모리 사용량 초과
  - JDBC 커넥션 고갈
  - 에러 로그 통계

