# 마이크로미터, 프로메테우스, 그라파나

세상에는 수많은 모니터링 툴이 있고, 시스템의 다양한 정보를 이 모니터링 툴에 전달해서 사용하게 된다.

## 마이크로미터(Micrometer)

만약에 기존에 사용했던 모니터링 툴을 변경하면 어떻게 될까?
기존에 측정했던 코드를 모두 변경한 툴에 맞게 변경해야한다. 이러한 문제를 해결해 주는것이 마이크로미터라는 라이브러리이다.

![이미지 이름](https://velog.velcdn.com/images/zenon8485/post/9efbab69-639f-4365-bc86-05336b08505c/image.png)

 - CPU, JVM, 커넥션 사용을 micro 표준방식에 맞추어 전달하면, 마이크로미터는 JMX 구현체나 Prometheus 구현체에 맞도록 변환해서 전달한다. 
- 마이크로미터는 애플리케이션 메트릭 파사드라고 불리는데, 애플리케이션의 메트릭(측정 지표)을
  마이크로미터가 정한 표준 방법으로 모아서 제공해준다.
- 개발자는 마이크로미터가 정한 표준 방법으로 메트릭(측정 지표)를 전달하면 된다. 그리고 사용하는
  모니터링 툴에 맞는 구현체를 선택하면 된다.
- 마이크로가 지원하는 모니터링 툴 종류

  [](https://micrometer.io/docs)



### 메트릭 확인하기

많은 지표를 수집하는 방법은 각각의 지표를 마이크로미터가 제공하는 표준 방법에 따라 등록하면 된다.
이를 마이크로미터가 지원하는데 스프링 부트 액츄에이터는 제공하는 지표 수집을 `@AutoConfiguration`을 통해 자동으로 등록해준다.
예를들어 JVM 메모리 사용량을 확인하고 싶으면 http://localhost:8080/actuator/metrics/jvm.memory.used


### 다양한 메트릭

마이크로 미터와 액츄에이터가 기본으로 제공하는 다양한 메트릭이 있다.

- JVM 메트릭 : JVM 관련 메트릭을 제공
- 시스템 매트릭
- 애플리케이션 시작 메트릭
- 스프링 MVC 메트릭 : 스프링 MVC 컨트롤러가 처리하는 모든 요청 관련
- 데이터소스 메트릭 : DataSource , 커넥션 풀에 관한 메트릭
- 로그 메트릭
- 사용자 정의 메트릭 :
    - 사용자가 직접 메트릭을 정의할수도 있다. 예를들어 주문수 , 취소수를 메트릭으로 만들 수 있다.

## 프로메테우스

애플리케이션에서 발생한 메트릭을 그 순간만 확인하는 것이 아니라 과거 이력까지 함께 확인하려면
메트릭을 보관하는 DB가 필요하다. 이렇게 하려면 어디선가 메트릭을 지속해서 수집하고 DB에 저장해야
한다. 프로메테우스가 바로 이런 역할을 담당한다.

## 그라파나

프로메테우스가 DB라고 하면, 이 DB에 있는 데이터를 불러서 사용자가 보기 편하게 보여주는 대시보드가
필요하다. 그라파나는 매우 유연하고, 데이터를 그래프로 보여주는 툴이다. 수 많은 그래프를 제공하고,
프로메테우스를 포함한 다양한 데이터소스를 지원한다.

### 방식

![이미지 이름](https://velog.velcdn.com/images/wnsqud70/post/1bd73173-0423-4140-8aff-2429a2646dc2/image.png)

1. 스프링 부트 액츄에이터와 마이크로미터를 사용하면 수 많은 메트릭을 자동으로 생성한다.
    - 마이크로미터 프로메테우스 구현체는 프로메테우스가 읽을 수 있는 포멧으로 메트릭을 생성한다.
2. 프로메테우스는 이렇게 만들어진 메트릭을 지속해서 수집한다.
3. 프로메테우스는 수집한 메트릭을 내부 DB에 저장한다.
4. 사용자는 그라파나 대시보드 툴을 통해 그래프로 편리하게 메트릭을 조회한다. 이때 필요한 데이터는
   프로메테우스를 통해서 조회한다.

### 프로메테우스 - 어플리케이션 설정

프로메테우스는 메트릭을 수집하고 보관하는 DB이다. 이 프로메테우스가 우리 어플리케이션의 메트릭을 수집하도록 연동하려면

1. `애플리케이션 설정` : 프로메테우스가 애플리케이션의 메트릭을 가져갈 수 있도록 애플리케이션에서
   프로메테우스 포멧에 맞추어 메트릭 만들기
    - 마이크로미터 프로메테우스 구현 라이브러리를 추가하면된다. 이렇게 하면 스프링 부트와 액츄에이터가 자동으로 마이크로미터 프로메테우스 구현체를 등록해서 동작하도록 설정해준다.

    ```bash
    implementation 'io.micrometer:micrometer-registry-prometheus' //추가
    ```

2. `프로메테우스 설정`: 프로메테우스가 우리 애플리케이션의 메트릭을 주기적으로 수집하도록 설정
    - `prometheus.yml` 에 코드를 추가한다

    ```bash
    #추가
    - job_name: "spring-actuator"
    metrics_path: '/actuator/prometheus' //수집경로
    scrape_interval: 1s //수집 주기 
    static_configs: - targets: ['localhost:8080'] //수집 서버의 IP, PORT
    ```


### 프로메테우스 - 게이지와 카운터

메트릭을 게이지와 카운터로 크게 2가지로 분류할 수 있다.

- `게이지` : 임의로 오르내릴 수있는 값 ex) CPU 사용량, 메모리 사용량
- `카운터` : 간순하게 증가하는 단일 누적 값 ex) HTTP 요청 수 , 로그 발생 수
    - `increase(),` `rate()`를 사용해서 그래프를 표현을 할 수 있다.

### 그라파나

그리파나 실행시 주의할점은 먼저 3가지를 수행해야한다.

1. 어플리케이션 실행
2. 프로메테우스 실행
3. 그라파나 실행

그리고 이미 잘 만들어진 대시보드를 활용하면 편리하게 모니터링 환경을 구성할 수 있다.

하지만 문제가 발생했을 때 어떻게 모니터링을 해야할까? 실제 문제를 발생시킨 다음에 그라파나를 통해 문제를 어떻게 모니터링할 수있는지 확인해보자

CPU 사용량 초과 상황을 예를들자면

```java

@Slf4j
@RestController
public class TrafficController {
	
	@GetMapping("/cpu")
	public String cpu() {
		  log.info("cpu");
			long value =0;
			for (long i = 0; i < 100000000000L; i++) {
			value++;
	}

return "ok value=" + value; } }
```

이렇게 실행하면 대시보드를 통해 CPU사용량이 증가하는 것을 확인할 수 있다.

이 상황말고도 위과 같은 상황을 만들어서 모니터링을 확인할 수 있다.

- JVM 메모리 사용량 초과
- 커넥션 풀 고갈
- 에러 로그 급증